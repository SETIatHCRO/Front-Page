## <u> Collision Antennas </u>

### Background

The 3 collision trio antennas (3f, 3g, 3h) are located close enough to collide with each other given certain
orientations.  A JSDA service <i>CollisionServer</i> running on antcntl receives telemetry from these antennas
and judges whether each is should be allowed to move.

### Current Implementation

#### Drivebox motion enable/disable mechanism

The drivebox controls motor speeds through the Copley Accelnet servo amps by using the amp's velocity mode control.
The drivebox generates pulse trains for both az and el servo amps, and the amps translate this proportionally into the
desired motors speed.  The pulse train always has 50% duty cycle (it is not PWM).  These pulse trains are
generated by ip2022-based drivebox firmware's <i>TMR0</i> interrupt routine.

The drivebox firmware listens on <i>UDP</i> port 1519 for "pulse" packets, which is just a packet with the
payload >= 5 bytes containing `pulse` as those first 5 bytes.  With each pulse packet received, a counter is reset to 4,
and is decremented in the watchdog timer service routine which runs at 1 Hz.  The pulse train generator code returns
early when the counter value is > 0, effectively stopping pulse generation and thus motion immediately halts or cannot
started.  The implication of this is that should motion be judged externally by CollisionServer, the antenna may
continue to move for 3-4 seconds while the counter runs down.

There is only one "pulse" enable counter, and it controls both axes together.

#### Non-collision antenna behavior

For the non-collision antenna case, the controlbox continously sends the "pulse" UPD messages to the drivebox at 1 Hz,
so pulse-train generation and thus motion is always possible.

#### Telemetry and drive enable messaging

- `controlbox:encoder_thread()`:<br>Sends encoder readings at 10 Hz to `DishServer:Tracker:EncoderServer` at UDP localhost:1515


- `controlbox:wrappot_thread()`:<br>For collision ants, sends wrappot readings to `CollisionServer` at UDP antcntl:1515
at 1 Hz.  For non-collision ants, it sends `pulse` messages to the drivebox UDP port 1519 at 1 Hz.


- `EncoderServer:DatagramLoop()`:<br>Receives encoder reading messages on UDP port 1515


- `EncoderServer:azEncoderCollisionLoop()`:<br>Receives encoder reading messages on UDP port 1515, calculates az angle
and forwards az position to `CollisionServer` at UDP antcntl:1515


- `CollisionServer:RunReceiveThread()`:<br>Receives `wrappot` and `az` packets from the embedded EncoderServer on a
collision ant, processes and if judged ok, sends a `pulse` packet to that ant's controlbox UDP port 1517.


- `controlbox:drivebox_thread()`:<br>listens on UDP port 1517 for `pulse` messages from `CollisionServer`, essentially
forwarding them to the drivebox UDP port 1519.  

#### CollisionServer

<i>TODO</i>
